package com.beaver.feb061.sns;

import java.io.File;
import java.net.URLDecoder;
import java.net.URLEncoder;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.text.SimpleDateFormat;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.beaver.db.manager.BeaverDBManager;
import com.oreilly.servlet.MultipartRequest;
import com.oreilly.servlet.multipart.DefaultFileRenamePolicy;

public class MemberDAO {
	
	// íšŒì›ê°€ì…
	public static void signup(HttpServletRequest req) {
		// ì¼ë‹¨ íŒŒì¼ì—…ë¡œë“œ ì‹œë„
		String path = null;
		MultipartRequest mr = null;
		
		try {
			path = req.getServletContext().getRealPath("img");
			System.out.println(path);
			mr = new MultipartRequest(req, path, 10 * 1024 * 1024, "UTF-8", new DefaultFileRenamePolicy());
		} catch (Exception e) {	// íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨ì˜ ê²½ìš°
			e.printStackTrace();
			req.setAttribute("r", "íšŒì›ê°€ì… ì‹¤íŒ¨(ì‚¬ì§„íŒŒì¼ ìš©ëŸ‰ ì´ˆê³¼)");
			return;	// ì—…ë¡œë“œì— ì‹¤íŒ¨í•˜ë©´ ë’¤ì— ë‚¨ì€ DBì‘ì—…
					//	ì€ í•˜ì§ ë§ì (ê°•ì œì¢…ë£Œ)
		}
		
		// íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µì‹œì— ê³„ì† ì§„í–‰
		Connection con = null;
		PreparedStatement pstmt = null;
		try {
			con = BeaverDBManager.connect("sexy");
			
			String id = mr.getParameter("id");
			String pw = mr.getParameter("pw");
			String name = mr.getParameter("name");
			String phone = mr.getParameter("phone");
			
			String y = mr.getParameter("y");
//			int y = Integer.parseInt(mr.getParameter("y"));
			int m = Integer.parseInt(mr.getParameter("m"));
			int d = Integer.parseInt(mr.getParameter("d"));
			String birthday = String.format("%s%02d%02d", y, m, d);
			System.out.println("ìƒë…„ì›”ì¼: " + birthday);
			String photo = mr.getFilesystemName("photo");
			if (photo != null) {
			    photo = URLEncoder.encode(photo, "UTF-8").replace("+", " ");
			} else {
			    photo = "cat.png";  // ê¸°ë³¸ ì´ë¯¸ì§€ ì„¤ì •
			}
			
			String sql = "insert into feb06_member values( "
					+ "?, ?, ?, ?, to_date(?, 'YYYYMMDD'), ?)";
			pstmt = con.prepareStatement(sql);
			
			pstmt.setString(1, id);
			pstmt.setString(2, pw);
			pstmt.setString(3, name);
			pstmt.setString(4, phone);
			pstmt.setString(5, birthday);
			pstmt.setString(6, photo);
			
			if (pstmt.executeUpdate() == 1) {
				req.setAttribute("r", "íšŒì›ê°€ì… ì„±ê³µ");
				
			}
		} catch (Exception e) {	// IDì¤‘ë³µ, DBì—°ê²°ìƒíƒœê°€ ì•ˆì¢‹ì€ ê²½ìš°ì¼ê²ë‹ˆë‹¤
			e.printStackTrace();
			// DBìª½ ë¬¸ì œë¡œ ê°€ì…ì€ ì‹¤íŒ¨ì§€ë§Œ,
			// í˜„ ë©”ì†Œë“œì˜ ì²˜ìŒ ë¶€ë¶„) ì‚¬ì§„íŒŒì¼ì´ ì—…ë¡œë“œëŠ” ë˜ì–´ìˆëŠ” ìƒíƒœ
			// ì‚¬ì§„íŒŒì¼ ì§€ì›Œì¤˜ì•¼(Javaë¡œ)
			File f = new File(path + "/" + mr.getFilesystemName("photo"));	// íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ê³ ? ê·¼ë° ì™œ new?
			f.delete(); // íŒŒì¼ì€ ì§€ì›Œë²„ë¦´ ê±°êµ¬ìš”
			req.setAttribute("r", "íšŒì›ê°€ì… ì‹¤íŒ¨, ì•„ì´ë””ê°€ ì¤‘ë³µì´ê±°ë‚˜ ì—°ê²°ìƒíƒœê°€ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤");
		}
			BeaverDBManager.close(con, pstmt, null);
	}
	
	public static void login(HttpServletRequest req, HttpServletResponse res) {
		Connection con = null;
		// ì—°ê²° ì¤€ë¹„ -				ğŸ”¹ DBì™€ì˜ ì—°ê²°ì„ ì¤€ë¹„í•˜ëŠ” ê°ì²´ (ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìœ¼ë©°, ì´í›„ ì‹¤ì œ ì—°ê²°ì„ ìˆ˜í–‰í•  ì˜ˆì •)
		PreparedStatement pstmt = null;
		// ì‹¤í–‰ ì¤€ë¹„ -				ğŸ”¹ Connectionì„ í†µí•´ ìƒì„±ëœ SQL ì‹¤í–‰ ì¤€ë¹„ ê°ì²´(PreparedStatement)
		//						ğŸ”¹ SQLì„ ë¯¸ë¦¬ ì¤€ë¹„(Precompile)í•˜ê³ , ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•¨
		//						ğŸ”¹  `?`(ë°”ì¸ë”© ë³€ìˆ˜)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì  SQL ì‹¤í–‰ì´ ê°€ëŠ¥í•¨
		ResultSet rs = null;
		// sqlì„ ì¡°íšŒí•œ ê²°ê³¼ê°’ ì €ì¥ - ğŸ”¹ SQL `SELECT` ì¡°íšŒ ê²°ê³¼ë¥¼ ì €ì¥í•˜ëŠ” ê°ì²´
		//						ğŸ”¹ ì•„ì§ ë°ì´í„°ê°€ ì—†ëŠ” ìƒíƒœì´ë©°, `pstmt.executeQuery();`ê°€ ì‹¤í–‰ë˜ë©´ DBì—ì„œ ì¡°íšŒëœ ê²°ê³¼ë¥¼ ì €ì¥í•¨
		//						ğŸ”¹ ì‚¬ìš©ìëŠ” `rs.next()`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡°íšŒëœ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆìŒ
		try {
			con = BeaverDBManager.connect("sexy");
			//  'ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ì—°ê²°'ì„ ìƒì„±í•˜ëŠ” ì—­í•  - BeaverDBManager í´ë˜ìŠ¤ì˜ connect() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ "sexy"ë¼ëŠ” ì´ë¦„ì˜ íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤(DB)ì™€ ì—°ê²°ì„ ìƒì„±í•˜ëŠ” ì—­í• 
			
			req.setCharacterEncoding("UTF-8");
			String id = req.getParameter("id");
			String pw = req.getParameter("pw");
			
			// String sql = "select * feb06_sns"; // ë¹„êµ í™•ì¸ì„ í•˜ë ¤ë©´ ë¶ˆëŸ¬ì˜¤ê³  ë¹„êµë¥¼ í•´ì•¼í•˜ëŠ”ë° ì™¼ìª½ì²˜ëŸ¼ ì „ë¶€ ë¶ˆëŸ¬ì˜¤ë©´ ê°œìˆ˜ê°€ ë§Œê°œì´ìƒì²˜ëŸ¼ ë§ì•„ì§ˆë•ŒëŠ” íš¨ìœ¨ì ì´ì§€ ì•ŠìŒ
			// String sql = "select * feb06_sns where id=? and pw=?"; 
			// í•´í‚¹ê¸°ë²• - SQL Injection (í•´í‚¹ ê¸°ë²•ì¤‘ ì´ëŸ°ê²Œ ìˆë‹¤)
			//		ë³´ì•ˆìƒ ì·¨ì•½ì ì„ ì´ìš©í•´ì„œ
			//		ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¹„ì •ìƒì ì¸ ë™ì‘ì„ í•˜ê²Œ í•˜ëŠ” ê¸°ë²•
			//â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
			
			String sql = "select * from feb06_member where id = ?";
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, id);
			rs = pstmt.executeQuery();
			
			if (rs.next()) { // ë°ì´í„°ê°€ ìˆëŠ”ì§€ + ê·¸ ë°ì´í„°ë¥¼ ê°€ë¦¬í‚¤ê²Œ // ì•ˆì „ì¥ì¹˜
				String dbPw = rs.getString("pw"); // dbì— ìˆëŠ” ë¹„ë°€ë²ˆí˜¸ì™€
				if (dbPw.equals(pw)) { // ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ê°€ ê°™(ì€ì§€)ë‹¤ë©´
					Member m = new Member(
							rs.getString("id"), dbPw, rs.getString("name"),
							rs.getString("phone"), rs.getDate("birth"),
							URLDecoder.decode(rs.getString("photo"), "UTF-8"));
					req.getSession().setAttribute("loginMember", m);
					req.getSession().setMaxInactiveInterval(600);
					
					Cookie c = new Cookie("lastLoginId", id);
					c.setMaxAge(60 * 60 * 24 * 5);
					res.addCookie(c);
					req.setAttribute("r", "ë¡œê·¸ì¸ ì„±ê³µ");
				} else { // dbì˜ ë¹„ë°€ë²ˆí˜¸ì™€ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¥¸ê²½ìš°
					req.setAttribute("r", "ë¡œê·¸ì¸ì‹¤íŒ¨(PWì˜¤ë¥˜)");
				}
			} else {
				req.setAttribute("r", "ë¡œê·¸ì¸ì‹¤íŒ¨(ë¯¸ê°€ì…ID)");
			}
		} catch (Exception e) {
			e.printStackTrace();
			req.setAttribute("r", "ë¡œê·¸ì¸ì‹¤íŒ¨(DBì„œë²„)");
		}
		BeaverDBManager.close(con, pstmt, rs);
	}
	
	// ë¡œê·¸ì¸ìƒíƒœ í™•ì¸í•˜ê¸°ìœ„í•œ ë©”ì†Œë“œ
	public static boolean loginCheck(HttpServletRequest req) {
		Member m = (Member) req.getSession().getAttribute("loginMember");
		
		if (m != null) {
			// ë¡œê·¸ì¸ ì„±ê³µ or ìƒíƒœ ìœ ì§€ì‹œ
			req.setAttribute("lp", "welcome.jsp");
			return true;
		}
		// ë¡œê·¸ì¸ìƒíƒœê°€ ì•„ë‹ˆê±°ë‚˜ ë¡œê·¸ì¸ ì‹¤íŒ¨ì‹œ
		req.setAttribute("lp", "login.jsp");
		return false;
	}
	
	//ë¡œê·¸ì•„ì›ƒ
	public static void logout(HttpServletRequest req) {
		// ì„¸ì…˜ ëŠê¸° : ì•„ë˜ì²˜ëŸ¼ ëŠìœ¼ë©´ ë‹¤ë¥¸ ì„¸ì…˜ê°’ë“¤ë„ ê°™ì´ ëŠì–´ì§€ê¸°ì— ë¹„ì¶”
		// req.getSession().setMaxInactiveInterval(-1);
		
		// Memberì— ëŒ€í•œ sessionë§Œ nullë¡œ ë°”ê¿”ì£¼ë©´ ë  ê²ƒ ê°™ë‹¤
		req.getSession().setAttribute("loginMember", null);
		req.setAttribute("r", "ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");
	}
	
	// ì •ë³´ ìˆ˜ì •
	public static void update(HttpServletRequest req) {
		// íšŒì›ê°€ì…ë•Œì™€ ë§ˆì°¬ê°€ì§€ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨í•˜ë©´ => ê±°ê¸°ì„œ ëë‚´ê¸°
		String path = null;
		MultipartRequest mr = null;
		Member m = (Member) req.getSession().getAttribute("loginMember");
		String old_photo = m.getPhoto();
		String new_photo = null;
		
		try {
			path = req.getServletContext().getRealPath("img");
			System.out.println(path);
			mr = new MultipartRequest(req, path, 10 * 1024 * 1024, "UTF-8", new DefaultFileRenamePolicy());
			
			new_photo = mr.getFilesystemName("photo"); // ì„ íƒí•œ íŒŒì¼ëª…
			if (new_photo != null) {	// ì´ ìˆìœ¼ë©´(ìƒˆë¡œìš´ íŒŒì¼ì„ ë„£ì—ˆìœ¼ë©´)
				new_photo = URLEncoder.encode(new_photo, "UTF-8").replace("+", " ");
			} else {	// ì´ ì—†ìœ¼ë©´ (ìƒˆë¡œìš´ íŒŒì¼ì„ ì•ˆë„£ì—ˆìœ¼ë©´)
				new_photo = old_photo;	// ê¸°ì¡´ì˜ ì‚¬ì§„ì„ ìƒˆë¡œìš´ ì‚¬ì§„ìœ¼ë¡œ ì§€ì •í•¨ìœ¼ë¡œì¨ ìœ ì§€
			}
		} catch (Exception e) {
			e.printStackTrace();
			System.out.println("íŒŒì¼ìš©ëŸ‰ ì²´í¬");
			return;
		}
		
		// ì—¬ê¸°ê¹Œì§€ ì§„í–‰í•˜ëŠ”ë° ë³„ì¼ ì—†ì—ˆë‹¤
		
		// íŒŒì¼ í¬ê¸°ê°€ 10MBë³´ë‹¤ ì ì€ê±¸ë¡œ ì˜ ì„ íƒí•´ì„œ - íŒŒì¼ì—…ë¡œë“œ ì„±ê³µ
		// íŒŒì¼ ì„ íƒ ì•ˆí•´ì„œ(0MB)
		
		// íŒŒì¼ ì„ íƒì„ í–ˆë‹¤ : í”„ì‚¬ ë°”ê¾¸ê² ë‹¤
		//		=> ìƒˆ í”„ì‚¬ íŒŒì¼ëª…ì„ DBì— ë„£ì–´ì•¼
		//		=> ìƒˆ í”„ì‚¬ íŒŒì¼ëª… í™•ë³´
		//		+ ê¸°ì¡´ í”„ì‚¬ íŒŒì¼ ì‚­ì œë„ í•´ì•¼
		//		=> ì›ë˜ í”„ì‚¬ íŒŒì¼ëª…ì„ í™•ë³´
		
		// íŒŒì¼ ì„ íƒì„ ì•ˆí•˜ë©´ : í”„ì‚¬ëŠ” ì•ˆë°”ê¾¸ê² ë‹¤
		//		=> ê¸°ì¡´ í”„ì‚¬ íŒŒì¼ëª…ì„ DBì— ë„£ì–´ì•¼
		//		=> ì›ë˜ í”„ì‚¬ íŒŒì¼ëª…ì„ í™•ë³´
		
		Connection con = null;
		PreparedStatement pstmt = null;
		try {
			con = BeaverDBManager.connect("sexy");
			
			String id = mr.getParameter("id");
			String pw = mr.getParameter("pw");
			String name = mr.getParameter("name");
			String phone = mr.getParameter("phone");
			
			String y = mr.getParameter("y");
			int mm = Integer.parseInt(mr.getParameter("m"));
			int dd = Integer.parseInt(mr.getParameter("d"));
			String birthday = String.format("%s%02d%02d", y, mm, dd);
			
			String sql = "update feb06_member set pw=?, name=?, "
					+ "birthday=to_date(?, 'YYYYMMDD'), photo=? "
					+ "where id=?";
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, pw);
			pstmt.setString(2, name);
			pstmt.setString(3, phone);
			pstmt.setString(4, birthday);
			pstmt.setString(5, new_photo);
			pstmt.setString(6, id);
			
			if (pstmt.executeUpdate() == 1) {	// ì •ë³´ìˆ˜ì •ì— ì„±ê³µí–ˆì„ ê²½ìš°
				req.setAttribute("r", "ì •ë³´ìˆ˜ì • ì„±ê³µ");
				
				if (!new_photo.equals(old_photo)) {	// í”„ì‚¬ë¥¼ ë°”ê¿¨ìœ¼ë©´
					new File(path + "/" + URLDecoder.decode(old_photo, "UTF-8")).delete();
				}
				SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
				m = new Member(id, pw, name, phone, sdf.parse(birthday), URLDecoder.decode(old_photo, "UTF-8"));
				req.getSession().setAttribute("loginMember", m);
			} else {	// ê°€ ì•„ë‹ˆë©´
				req.setAttribute("r", "ì •ë³´ìˆ˜ì • ì‹¤íŒ¨");
				if (!new_photo.equals(old_photo)) {
					new File(path + "/" + URLDecoder.decode(new_photo, "UTF-8")).delete();
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
			req.setAttribute("r", "ì •ë³´ìˆ˜ì • ì‹¤íŒ¨(DBë¬¸ì œ)");
			try {
				if (!new_photo.equals(old_photo)) {
					new File(path + "/" + URLDecoder.decode(new_photo, "UTF-8")).delete();
				}
			} catch (Exception e2) {
				e2.printStackTrace();
			}
		}
		BeaverDBManager.close(con, pstmt, null);
	}
	
	// íšŒì› íƒˆí‡´
	public static void delete(HttpServletRequest req) {
		Connection con = null;
		PreparedStatement pstmt = null;
		try {
			con = BeaverDBManager.connect("sexy");
			Member m = (Member) req.getSession().getAttribute("loginMember");
			String id = m.getId();
			
			String sql = "delete feb06_member where id = ?";
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, id);
			
			if (pstmt.executeUpdate() == 1) {
				req.setAttribute("r", "íšŒì›íƒˆí‡´ ì„±ê³µ");
				// DBì—ì„œ ë°ì´í„°ëŠ” ì§€ì› ìŒ
				// ê·¸ ì‚¬ëŒì´ ì‚¬ìš©í•œ í”„ì‚¬ => ì§€ì›Œì•¼í•¨
				String photo = m.getPhoto();
				photo = URLDecoder.decode(photo, "UTF-8");
				String path = req.getServletContext().getRealPath("img");
				File f = new File(path + "/" + photo);
				f.delete();
				req.getSession().setAttribute("loginMember", null);
			} else {
				req.setAttribute("r", "ì´ë¯¸ íƒˆí‡´ì²˜ë¦¬ë¨");
			}
		} catch (Exception e) {
			e.printStackTrace();
			req.setAttribute("r", "íƒˆí‡´ì‹¤íŒ¨(DBì„œë²„)");
		}
		BeaverDBManager.close(con, pstmt, null);
	}
	
	
	
	
	
	
	
	
	
	
	
	
}




























